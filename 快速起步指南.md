# Portable PsyAgent - 生产项目快速起步指南

🚀 **5分钟快速部署您的专业心理评估系统**

## 📋 目录

- [系统要求](#系统要求)
- [快速安装](#快速安装)
- [基础配置](#基础配置)
- [首次使用](#首次使用)
- [生产部署](#生产部署)
- [常见问题](#常见问题)
- [技术支持](#技术支持)

## 🔧 系统要求

### 最低配置
- **操作系统**: Windows 10/11, macOS 10.15+, Ubuntu 18.04+
- **Python**: 3.8 或更高版本
- **内存**: 4GB RAM (推荐 8GB+)
- **存储**: 2GB 可用空间
- **网络**: 稳定的互联网连接（用于云模型）

### 推荐配置
- **操作系统**: Ubuntu 20.04+ 或 Windows 11
- **Python**: 3.9+
- **内存**: 16GB RAM
- **存储**: 10GB SSD
- **GPU**: NVIDIA GPU（可选，用于本地模型加速）

## ⚡ 快速安装

### 方法一：一键安装脚本（推荐）

```bash
# 下载项目
git clone https://github.com/ptreezh/AgentPsyAssessment.git
cd AgentPsyAssessment

# 运行安装脚本
chmod +x install.sh
./install.sh
```

### 方法二：手动安装

```bash
# 1. 克隆项目
git clone https://github.com/ptreezh/AgentPsyAssessment.git
cd AgentPsyAssessment

# 2. 创建虚拟环境
python -m venv venv

# 3. 激活虚拟环境
# Windows:
venv\Scripts\activate
# macOS/Linux:
source venv/bin/activate

# 4. 安装依赖
pip install -r requirements.txt

# 5. 验证安装
python -c "import unified_api_client; print('✅ 安装成功')"
```

## 🔑 基础配置

### 1. 环境变量设置

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑配置文件
nano .env  # 或用记事本打开
```

**必需配置**：
```env
# OpenRouter API密钥（推荐获取）
OPENROUTER_API_KEY=your_openrouter_api_key_here

# Ollama本地模型（可选）
OLLAMA_HOST=http://localhost:11434
```

### 2. 获取OpenRouter API密钥

1. 访问 [OpenRouter官网](https://openrouter.ai)
2. 注册账户并登录
3. 前往 [API密钥页面](https://openrouter.ai/keys)
4. 创建新的API密钥
5. 将密钥添加到`.env`文件中

### 3. 配置本地模型（可选）

```bash
# 安装Ollama（如果需要本地模型）
curl -fsSL https://ollama.ai/install.sh | sh

# 下载推荐模型
ollama pull llama3.1
ollama pull qwen2.5
```

### 4. 验证配置

```bash
# 运行配置验证
python test_openrouter_integration.py

# 预期输出：
# ✅ OPENROUTER_API_KEY 已设置
# ✅ 统一API客户端创建成功
# ✅ OpenRouter连接正常
```

## 🎯 首次使用

### 快速测试评估

```python
# 创建测试脚本 quick_demo.py
from unified_api_client import create_unified_client

def quick_demo():
    """快速演示"""
    print("🧠 Portable PsyAgent 快速演示")
    print("=" * 40)

    # 创建客户端
    client = create_unified_client()

    # 测试连接
    connections = client.test_connection()
    print(f"OpenRouter: {'✅' if connections['openrouter'] else '❌'}")
    print(f"Ollama: {'✅' if connections['ollama'] else '❌'}")

    # 获取推荐模型
    models = client.get_recommended_models("evaluation")
    print(f"\n推荐评估模型: {models[0]['model']}")

    # 模拟评估
    messages = [
        {"role": "system", "content": "你是专业的心理评估师"},
        {"role": "user", "content": "请简要说明大五人格模型的主要内容"}
    ]

    try:
        response = client.chat_completion(
            model=models[0]['model'],
            messages=messages,
            max_tokens=200
        )

        content = response["choices"][0]["message"]["content"]
        print(f"\n评估结果预览: {content[:100]}...")

        # 计算成本
        usage = response.get("usage", {})
        cost = client.calculate_cost(
            models[0]['model'],
            usage.get("prompt_tokens", 0),
            usage.get("completion_tokens", 0)
        )
        print(f"本次调用成本: ${cost:.6f}")

    except Exception as e:
        print(f"❌ 测试失败: {e}")

if __name__ == "__main__":
    quick_demo()
```

运行演示：
```bash
python quick_demo.py
```

### 处理真实评估数据

```bash
# 1. 准备评估数据（JSON格式）
# 将您的评估文件放入 data/input/ 目录

# 2. 运行批量评估
python optimized_batch_processor.py \
  --input-dir data/input \
  --output-dir data/output \
  --enhanced

# 3. 查看结果
ls data/output/final_evaluated/
```

## 🏭 生产部署

### Docker部署（推荐）

```dockerfile
# Dockerfile
FROM python:3.9-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# 复制项目文件
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

# 创建非root用户
RUN useradd -m -u 1000 psyuser && chown -R psyuser:psyuser /app
USER psyuser

# 暴露端口（如果需要Web界面）
EXPOSE 8000

# 启动命令
CMD ["python", "batch_processing/optimized_batch_processor.py", "--daemon"]
```

**部署命令**：
```bash
# 构建镜像
docker build -t portable-psyagent .

# 运行容器
docker run -d \
  --name psyagent \
  --env-file .env \
  -v $(pwd)/data:/app/data \
  -p 8000:8000 \
  portable-psyagent
```

### 云服务器部署

```bash
# 1. 服务器环境准备
sudo apt update && sudo apt install python3.9 python3.9-venv git

# 2. 项目部署
git clone https://github.com/ptreezh/AgentPsyAssessment.git
cd AgentPsyAssessment

# 3. 服务配置
sudo cp systemd/portable-psyagent.service /etc/systemd/system/
sudo systemctl enable portable-psyagent
sudo systemctl start portable-psyagent

# 4. 监控服务
sudo systemctl status portable-psyagent
```

### 批量处理配置

```bash
# 创建生产配置文件
cat > config/production.json << EOF
{
  "processing": {
    "concurrent_limit": 10,
    "batch_size": 50,
    "retry_attempts": 3,
    "checkpoint_interval": 10
  },
  "models": {
    "primary": "anthropic/claude-3.5-sonnet",
    "fallback": "openai/gpt-4o",
    "local": "llama3.1"
  },
  "output": {
    "format": "json",
    "compression": true,
    "backup": true
  }
}
EOF

# 运行生产模式
python optimized_batch_processor.py \
  --config config/production.json \
  --input-dir /data/input \
  --output-dir /data/output \
  --daemon
```

## 📊 监控和维护

### 日志监控

```bash
# 查看实时日志
tail -f logs/batch_processing.log

# 查看错误日志
grep "ERROR" logs/batch_processing.log | tail -20

# 性能监控
python -c "
import psutil
print(f'CPU使用率: {psutil.cpu_percent()}%')
print(f'内存使用率: {psutil.virtual_memory().percent}%')
"
```

### 数据备份

```bash
# 创建备份脚本
cat > backup.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/psyagent-$DATE"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据
cp -r data/output $BACKUP_DIR/
cp -r logs $BACKUP_DIR/
cp .env $BACKUP_DIR/

# 压缩备份
tar -czf "$BACKUP_DIR.tar.gz" $BACKUP_DIR
rm -rf $BACKUP_DIR

echo "备份完成: $BACKUP_DIR.tar.gz"
EOF

chmod +x backup.sh
./backup.sh
```

### 性能优化

```python
# config/performance.py
PERFORMANCE_CONFIG = {
    "batch_processing": {
        "optimal_batch_size": 20,  # 根据服务器配置调整
        "max_concurrent": 5,       # 并发处理数量
        "memory_limit": "8GB",     # 内存使用限制
    },
    "model_optimization": {
        "cache_responses": True,    # 缓存重复请求
        "compress_requests": True,  # 压缩请求数据
        "timeout": 300,            # 请求超时时间
    },
    "cost_control": {
        "daily_budget": 100.0,     # 每日预算限制
        "cost_alert": 80.0,        # 成本告警阈值
        "auto_fallback": True,     # 超预算自动降级
    }
}
```

## 🔧 常见问题

### Q1: OpenRouter API密钥设置后仍然提示未设置？

**解决方案**：
```bash
# 检查环境变量
echo $OPENROUTER_API_KEY

# 重新加载环境变量
source .env

# 验证配置
python -c "import os; print('API Key:', os.getenv('OPENROUTER_API_KEY', 'Not found'))"
```

### Q2: 批量处理速度很慢？

**优化方案**：
```bash
# 增加并发数
python optimized_batch_processor.py \
  --concurrent-limit 10 \
  --input-dir data/input \
  --output-dir data/output

# 使用本地模型减少网络延迟
export USE_LOCAL_MODEL=true
python optimized_batch_processor.py \
  --preferred-model llama3.1 \
  --input-dir data/input \
  --output-dir data/output
```

### Q3: 内存使用过高？

**解决方案**：
```python
# 在config/production.json中设置
{
  "processing": {
    "batch_size": 10,        # 减少批处理大小
    "memory_limit": "4GB",   # 限制内存使用
    "gc_frequency": 5        # 更频繁的垃圾回收
  }
}
```

### Q4: 如何处理中断的批量任务？

**断点续跑**：
```bash
# 自动检测断点继续处理
python optimized_batch_processor.py \
  --input-dir data/input \
  --output-dir data/output \
  --resume

# 手动指定起始点
python optimized_batch_processor.py \
  --input-dir data/input \
  --output-dir data/output \
  --start-index 100
```

## 📈 性能基准

### 处理能力参考

| 配置 | 每小时处理文件数 | 平均响应时间 | 成本/1000次评估 |
|------|------------------|--------------|----------------|
| Claude 3.5 Sonnet | 50-80 | 2-3秒 | $15-25 |
| GPT-4o | 80-120 | 1-2秒 | $12-20 |
| Llama 3.1 (本地) | 20-40 | 5-8秒 | $0 |
| 混合模式 | 60-100 | 2-4秒 | $8-15 |

### 硬件配置建议

| 用户规模 | CPU | 内存 | 存储 | 网络 |
|----------|-----|------|------|------|
| 个人使用 | 4核 | 8GB | 50GB SSD | 10Mbps |
| 小团队 | 8核 | 16GB | 200GB SSD | 100Mbps |
| 企业级 | 16核+ | 32GB+ | 1TB SSD | 1Gbps |

## 🆘 技术支持

### 获取帮助

1. **文档查阅**：
   - [完整API文档](docs/API_REFERENCE.md)
   - [配置说明](docs/CONFIGURATION.md)
   - [故障排除指南](docs/TROUBLESHOOTING.md)

2. **社区支持**：
   - [GitHub Issues](https://github.com/ptreezh/AgentPsyAssessment/issues)
   - [讨论区](https://github.com/ptreezh/AgentPsyAssessment/discussions)
   - QQ群：123456789

3. **商业支持**：
   - 邮箱：3061176@qq.com
   - 官网：https://agentpsy.com
   - 作者：ptreezh

### 错误报告

提交问题时请包含：

```bash
# 系统信息
python -c "
import platform, psutil, sys
print(f'系统: {platform.system()} {platform.release()}')
print(f'Python: {sys.version}')
print(f'内存: {psutil.virtual_memory().total / 1024**3:.1f}GB')
print(f'CPU: {psutil.cpu_count()}核')
"

# 错误日志
python your_script.py 2>&1 | tee error.log
```

---

## 🎉 开始您的心理评估之旅

恭喜！您已经成功部署了Portable PsyAgent心理评估系统。

**下一步建议**：
1. 运行 `python quick_demo.py` 进行首次测试
2. 查看 `docs/` 目录获取详细文档
3. 加入我们的用户社区获取支持

**专业提示**：定期运行 `python -m pytest tests/` 确保系统正常运行。

祝您使用愉快！🚀