# AgentPsy 测评方法、条件和结果分析

## 1. 测评方法

AgentPsy 通过`run_assessment_unified.py`脚本执行心理测评，主要流程如下：

### 1.1 测评启动
```bash
python llm_assessment/run_assessment_unified.py \
  --model_name ollama/gemma3:latest \
  --test_file big5 \
  --role_name a1 \
  --emotional-stress-level 2 \
  --cognitive-trap-type p \
  --context-length-mode dynamic \
  --context-length-dynamic 1/2
```

### 1.2 测评流程
1. **初始化**：加载模型、测试文件、角色文件
2. **压力因子配置**：根据参数设置情感压力、认知陷阱、上下文负载等
3. **逐题测评**：
   - 构建包含压力因子的对话提示
   - 发送提示给模型并获取响应
   - 提取最终响应并记录
4. **结果保存**：将测评结果和日志保存到指定目录

### 1.3 支持的测评类型
- **大五人格测试**：评估模型的五大性格维度
- **DASS测试**：评估模型的抑郁、焦虑、压力水平
- **动机测试**：评估模型的内在和外在动机
- **图形映射测试**：评估模型的认知映射能力

## 2. 测评条件

### 2.1 模型配置
- **本地模型**：通过Ollama服务运行，需配置API地址和密钥
- **云模型**：支持多种云服务，需配置相应的API密钥和模型ID
- **模型参数**：支持温度参数、上下文长度等配置

### 2.2 压力因子
#### 2.2.1 情感压力等级
- **等级0**：无压力
- **等级1**：轻微压力
- **等级2**：中等压力
- **等级3**：高压力
- **等级4**：极限压力

#### 2.2.2 认知陷阱类型
- **p (Paradox)**：悖论陷阱
- **c (Circularity)**：循环性陷阱
- **s (Semantic)**：语义谬误陷阱
- **r (Procedural)**：程序性陷阱

#### 2.2.3 上下文负载
- **静态模式**：指定固定的上下文长度（K为单位）
- **动态模式**：按模型最大上下文长度的比例设置
- **自动模式**：系统自动检测模型的最大上下文长度

### 2.3 角色配置
- **默认角色**：不加载特定角色文件
- **自定义角色**：加载`llm_assessment/roles/`目录下的角色文件
- **角色与MBTI映射**：系统内置角色与MBTI类型的映射关系

## 3. 结果分析

### 3.1 结果文件结构
```json
{
  "assessment_metadata": {
    "model_id": "ollama/gemma3:latest",
    "test_name": "big5",
    "role_name": "a1",
    "role_mbti_type": "ISTJ",
    "timestamp": "2025-09-08T10:30:00",
    "stress_factors_applied": {
      "emotional_stress_level": 2,
      "cognitive_trap_type": "p",
      "context_load_tokens": 2048
    },
    "assessment_status": "completed"
  },
  "assessment_results": [
    {
      "question_id": "big5_E_1",
      "question_data": {
        "id": "big5_E_1",
        "dimension": "E",
        "question": "我喜欢成为关注的焦点"
      },
      "conversation_log": [
        {
          "role": "system",
          "content": "你是一个严谨、负责的会计师..."
        },
        {
          "role": "user",
          "content": "[ASSESSMENT_QUESTION] 我喜欢成为关注的焦点"
        },
        {
          "role": "assistant",
          "content": "作为一个AI助手，我通常不会寻求成为关注的焦点..."
        }
      ],
      "extracted_response": "作为一个AI助手，我通常不会寻求成为关注的焦点...",
      "session_id": "question_0_big5_E_1"
    }
  ]
}
```

### 3.2 分析工具
#### 3.2.1 大五人格分析
通过`analyze_big5_results.py`脚本分析大五人格测试结果：
- 计算各维度的平均得分
- 映射到MBTI类型
- 生成个性特征分析报告

#### 3.2.2 其他测评分析
- **DASS分析**：计算抑郁、焦虑、压力三个维度的得分
- **动机分析**：评估内在动机和外在动机的强度

### 3.3 报告生成
#### 3.3.1 Markdown报告
包含以下内容：
- 测评基本信息（模型、测试、角色、压力因子等）
- 各维度得分和分析
- MBTI类型映射
- 个性特征描述

#### 3.3.2 JSON报告
包含结构化的分析数据，便于程序处理和进一步分析。

### 3.4 批量测评分析
通过批量测评配置，可以：
- 对比不同模型在同一测试下的表现
- 分析角色对测评结果的影响
- 评估压力因子对模型表现的影响
- 生成综合性的测评报告

## 4. 质量保证

### 4.1 测评验证
- **响应有效性检查**：确保模型返回了有效的响应
- **会话完整性验证**：验证对话历史的完整性
- **压力因子应用确认**：确认所有指定的压力因子都已正确应用

### 4.2 错误处理
- **连接性测试**：在测评前测试模型的连接性
- **超时处理**：支持设置模型响应的超时时间
- **重试机制**：对失败的请求进行重试
- **错误日志**：详细记录测评过程中的错误信息

### 4.3 结果一致性
- **会话隔离**：确保每个问题的测评独立进行
- **响应提取**：通过智能提取确保获取到正确的响应
- **日志记录**：完整的日志记录便于问题追踪和结果验证