# 分段可信评估系统需求规范文档 (Specification)

## 1. 系统概述

### 1.1 目标
实现一个可信的心理评估分析系统，能够对原始测评报告进行分段评分，通过多个独立评估器进行评分，解决分歧，并生成可靠的大五人格和MBTI分析结果。

### 1.2 核心需求
1. 至少三个独立评估器按照评分标准对原始测评报告的每道题进行独立评分
2. 生成评分依据和独立评分结果
3. 进行一致性对照，识别分歧
4. 当分歧过大时引入更多评估器重新评估
5. 取多数一致意见后进行完整的50题得分后的大五和MBTI分析
6. 标记完成评估的原始测评报告并移动到OK子目录
7. 如果文件过大，需分段评估评分再汇总

### 1.3 关键约束
- 评分必须遵循1-3-5三分制标准，不得使用其他数值
- 评估结果必须包含评分依据
- 争议解决机制支持多轮评估
- 系统应支持批量处理
- 需要提供信度验证

## 2. 功能规格说明

### 2.1 分段评分功能 (Segmented Scoring)
#### 2.1.1 输入
- 原始测评报告JSON文件 (包含50题回答)
- 分段大小参数 (默认2题/段)

#### 2.1.2 处理流程
1. 将50题原始测评报告按指定分段大小分段
2. 每段包含指定数量的题目 (例如2题/段则共25段)
3. 对每段生成独立评分提示

#### 2.1.3 输出
- 每段的评分结果 (包含Big5五维度评分)
- 每段评分的依据说明
- 分段处理时间戳

### 2.2 多评估器评分机制 (Multi-Evaluator Scoring)
#### 2.2.1 评估器配置
- 初始使用3个独立评估器
- 评估器类型：云模型 (OpenRouter) 与本地模型 (Ollama) 混合
- 模型列表按优先级排序

#### 2.2.2 评分流程
1. 每个评估器独立对每段进行评分
2. 为每个评估器生成独立评分结果
3. 每个评分包含：Big5五维度分值(1/3/5)、评分依据、置信度

#### 2.2.3 评估器回退机制
1. 优先尝试云模型
2. 云模型失败时自动切换到本地Ollama模型
3. 多级重试机制 (最多3次重试)
4. 指数退避策略

### 2.3 一致性对照功能 (Consistency Analysis)
#### 2.3.1 对照指标
- 每个Big5维度的评分范围
- 模型间一致性百分比
- 评分分布统计

#### 2.3.2 一致性评估标准
- 范围≤1：完全一致 (100%)
- 范围≤2：高度一致 (80%)
- 范围≤3：中等一致 (60%)
- 范围>3：差异较大 (40%)

### 2.4 争议解决机制 (Dispute Resolution)
#### 2.4.1 争议识别
- 评分范围>1视为争议
- 争议阈值可配置 (默认1分)

#### 2.4.2 解决流程
1. **争议识别阶段**：检测评分差异>阈值的问题
2. **额外评估阶段**：引入2个额外评估器
3. **多轮处理**：最多进行3轮争议解决
4. **多数决策**：去除最高分和最低分后取中位数

#### 2.4.3 多轮争议解决
- **第1轮**：使用云模型作为额外评估器
- **第2轮**：使用Ollama本地模型作为额外评估器
- **第3轮**：循环使用所有可用评估器

### 2.5 信度验证功能 (Reliability Validation)
#### 2.5.1 验证指标
- Cronbach's Alpha系数
- 评估者间信度 (Inter-rater reliability)
- 总体信度平均值

#### 2.5.2 验证标准
- 最低信度阈值：0.8
- 验证通过条件：总体信度≥0.8 且 Cronbach's Alpha≥0.8
- 单独评估者间信度≥0.8

### 2.6 大五和MBTI分析功能 (Big5 and MBTI Analysis)
#### 2.6.1 大五分析
- 基于多数决策后的50题汇总得分
- 计算五个维度的综合得分
- 提供人格特征描述

#### 2.6.2 MBTI映射分析
- 基于大五维度得分映射到MBTI类型
- 提供MBTI类型解释

### 2.7 报告处理功能 (Report Management)
#### 2.7.1 完成标记
- 成功评估的报告标记为已完成
- 生成完整评估报告

#### 2.7.2 文件移动
- 将完成评估的原始文件移动到"results/ok/original"目录
- 评估结果保存到"results/ok/evaluated"目录
- 保留处理日志

## 3. 数据格式规范

### 3.1 输入文件格式
```json
{
  "assessment_results": [
    {
      "question_id": "string",
      "question_data": {
        "mapped_ipip_concept": "string",
        "scenario": "string",
        "prompt_for_agent": "string"
      },
      "extracted_response": "string"
    }
  ]
}
```

### 3.2 评分结果格式
```json
{
  "success": true,
  "segment_number": int,
  "analysis_summary": "string",
  "scores": {
    "openness_to_experience": 1|3|5,
    "conscientiousness": 1|3|5,
    "extraversion": 1|3|5,
    "agreeableness": 1|3|5,
    "neuroticism": 1|3|5
  },
  "evidence": {
    "openness_to_experience": "string",
    "conscientiousness": "string",
    "extraversion": "string",
    "agreeableness": "string",
    "neuroticism": "string"
  },
  "confidence": "high|medium|low"
}
```

### 3.3 争议解决结果格式
```json
{
  "resolved_results": [
    {
      "question_id": int,
      "trait": "string",
      "final_score": int,
      "initial_disagreement": int,
      "resolved_by_round": int
    }
  ],
  "unresolved_disputes": [
    {
      "question_id": int,
      "trait": "string",
      "scores": [int],
      "max_diff": int
    }
  ],
  "new_scores": [
    {
      "question_id": int,
      "trait": "string",
      "score": int,
      "model": "string",
      "round": int
    }
  ],
  "rounds_used": int
}
```

## 4. 业务流程规范

### 4.1 主处理流程
1. **文件加载**：从"results/readonly-original"目录加载原始测评报告
2. **问题提取**：解析JSON提取50道题及其回答
3. **分段处理**：按指定大小分段(默认2题/段)
4. **初始评分**：使用3个评估器独立评分
5. **一致性检查**：计算模型间一致性
6. **争议识别**：识别评分差异>1的问题
7. **争议解决**：多轮解决争议(最多3轮，每次+2个评估器)
8. **多数决策**：采用多数原则确定最终评分
9. **信度验证**：验证结果信度≥0.8
10. **人格分析**：生成大五和MBTI分析
11. **结果保存**：保存完整报告并移动原始文件

### 4.2 异常处理流程
1. **API失败**：自动切换到备用评估器
2. **JSON解析失败**：记录错误并继续处理其他文件
3. **评分标准错误**：自动修正为1/3/5分制
4. **争议无法解决**：记录争议并继续处理

## 5. 质量标准

### 5.1 评分质量要求
- 评分严格遵循1-3-5三分制
- 每个评分必须提供具体证据
- 一致性≥60%为可接受
- 信度≥0.8为通过

### 5.2 性能要求
- 单个文件处理时间<10分钟
- 支持并发处理(可选)
- 内存使用<1GB
- 批量处理时支持中断和恢复

### 5.3 可靠性要求
- 至少95%的文件能够成功处理
- 评估器切换成功率>90%
- 争议解决成功率>80%

## 6. 测试要求 (TDD)

### 6.1 单元测试
- 分段功能测试
- 评分验证测试
- 一致性计算测试
- 争议识别测试

### 6.2 集成测试
- 多评估器评分流程测试
- 争议解决流程测试
- 端到端处理测试

### 6.3 压力测试
- 大文件处理测试
- 批量处理性能测试
- 长时间运行稳定性测试

## 7. 配置参数

### 7.1 默认参数
- 分段大小：2题/段
- 最大争议轮次：3轮
- 争议阈值：1分
- 信度阈值：0.8
- 初始评估器数：3个
- 每轮新增评估器：2个

### 7.2 可配置参数
- 评估器模型列表
- 分段大小参数
- 信度阈值
- 输出目录路径
- 最大重试次数